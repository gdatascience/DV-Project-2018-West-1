---
title: "DV-FinalProject-EDA"
author: "Tony Galvan"
date: "November 21, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages, message=FALSE, warning=FALSE, error=FALSE}
# this chunk will safely install and load some packages this code requires
if (!require("pacman")) install.packages("pacman")
pacman::p_load( skimr, DataExplorer, tidyverse, lubridate, ggmap, rgdal )

theme_set(theme_light())
```

In this R Markdown, we are going to explore the data for our Data Viz Final Project.

First, let's look at the 311 Contact Management Cases data.

#311 Contact Management Cases data

##Load the data

```{r}
cm_Cases = read.csv('311_Contact_Management_Cases.csv', stringsAsFactors = FALSE)
str(cm_Cases)
```

Let's run a "DataExplorer" report.

```{r}
create_report(cm_Cases)
```


Now, let's do some pre-processing of the data like:

*Converting a few date fields

```{r}
processed_cm_Cases = cm_Cases %>%
  mutate(dt_entry = ymd(substr(Entry_Date___Calc, 1, 10)),
         dt_close = ymd(substr(Close_Date___Calc, 1, 10)),
         days_open = dt_close - dt_entry)
```

##EDA

Let's look at cases opened over time.

```{r}
processed_cm_Cases %>%
  ggplot(aes(x = dt_entry)) + 
    geom_histogram(binwidth = 30)
```



#Code Enforcement Cases data

```{r}
ce_Cases = read.csv('Code_Enforcement_Cases.csv', stringsAsFactors = FALSE)
str(ce_Cases)
```

Let's plot the addresses on a map.

```{r}
ce_Cases_geo = geocode(paste(ce_Cases$Street_Address[1:10], 
                             ce_Cases$Zip_Code[1:10], 
                             sep = " "), 
                       output = "more")
```

#City Council Districts data

```{r}
districts = readOGR(dsn="City_Council_Districts", 
                    layer = "City_Council_Districts", 
                    stringsAsFactors = FALSE)
```

Let's see what the data looks like.

```{r}
summary(districts)
```


```{r}
head(districts@data)
```

Now, let's create a map using ggplot

```{r}
districts2 <- fortify(districts, region = 'Dist')
districts2  <- merge(districts2, districts@data, by.x = 'id', by.y = 'Dist')

ggplot(data = districts2) + geom_polygon(aes(x = long, y = lat, fill = id, group = group), color = "white") + 
  coord_fixed(1.3)
```


#Census data

```{r}
census = readOGR(dsn="2010_CensusData", 
                    layer = "2010_CensusData", 
                    stringsAsFactors = FALSE)
```

Let's see what the data looks like.

```{r}
summary(census)
```

```{r}
head(census@data)
```


Let's plot this using ggplot

```{r}
census2 <- fortify(census, region = 'NAME')
census2  <- merge(census2, census@data, by.x = 'id', by.y = 'NAME')

ggplot(data = census2) + geom_polygon(aes(x = long, y = lat, fill = id, group = group), color = "white") + 
  coord_fixed(1.3)
```

Let's try to layer these maps

```{r}
ggplot() + 
  geom_polygon(data = census2, 
               aes(x = long, y = lat, group = group), 
               color = "white") + 
  geom_polygon(data = districts2, 
               aes(x = long, y = lat, fill = Council_Me, group = group), 
               color = "black", 
               alpha = 0.5) + 
  coord_fixed(1.3)
```

#Street Light data

```{r}
lights = read.csv('Street_Lights.csv', stringsAsFactors = FALSE)
glimpse(lights)
```

Let's plot the lights on a map of districts.

```{r}
ggplot() + 
  geom_polygon(data = districts2, 
               aes(x = long, y = lat, fill = Council_Me, group = group), 
               color = "black", 
               alpha = 0.5) + 
  geom_point(data = lights,
             aes(x = Lon, y = Lat, color = Ownership, alpha = 0.5)) +
  coord_fixed(1.3)
```

### DAN ADDITIONS ###

```{r}
ab_property = readOGR(dsn="Abandoned_Property_Parcels", 
                    layer = "Abandoned_Property_Parcels", 
                    stringsAsFactors = FALSE)
```

Look at the strucure of the data:
```{r}
head(ab_property)
```

Try to understand the abandoned property data a bit more:
```{r}
ab_property@data %>% group_by(Property_S) %>% na.omit()
```


Plot the abandoned properties
```{r}
# first generate the basemap
ab.base.map <- ggmap::get_stamenmap(bbox = c(left = -86.36, bottom = 41.59, right = -86.14,top = 41.76), zoom = 12)
# then layer the property data over the top
ggmap(ab.base.map)+
  geom_point(data = ab_property, aes(x = long, y = lat))
```